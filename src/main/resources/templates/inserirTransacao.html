<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Realizar Venda - Mori Magazine</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" href="/path/to/favicon.ico" type="image/x-icon">

    <!-- Fontes Elegantes -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #1a1a1a; /* Fundo preto elegante */
            color: white;
            font-family: 'Open Sans', sans-serif; /* Fonte principal */
        }
        .navbar, .footer {
            background-color: #111; /* Preto profundo para navbar e rodap√© */
            color: white;
        }
        .navbar .nav-link {
            color: #d4af37; /* Dourado suave para links */
            font-weight: 600; /* Negrito para destaque */
        }
        .navbar .nav-link:hover {
            color: #b8860b; /* Dourado mais escuro no hover */
        }
        .container {
            background: #222; /* Fundo escuro para o container */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
        }
        h1 {
            color: #d4af37; /* Dourado suave para o t√≠tulo */
            font-size: 2.5rem;
            font-family: 'Merriweather', serif; /* Fonte elegante para o t√≠tulo */
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }
        .btn-custom {
            background-color: #d4af37; /* Dourado para bot√µes */
            color: white;
            font-weight: 700;
            padding: 5px 15px;
            border-radius: 50px; /* Bordas arredondadas para UX aprimorada */
        }
        .btn-custom:hover {
            background-color: #b8860b; /* Dourado mais escuro no hover */
            border-color: #b8860b;
            color: #fff;
        }
        .btn-danger {
            border-radius: 50px; /* Bordas arredondadas */
        }
        .form-group label, .form-control {
            color: #d4af37; /* Dourado suave para os labels e inputs */
        }
        .form-control {
            background-color: #333; /* Fundo escuro para os inputs */
            border: 1px solid #d4af37; /* Borda dourada */
        }
        .table thead th {
            background-color: #343a40; /* Fundo escuro para cabe√ßalho da tabela */
            color: white;
            font-family: 'Merriweather', serif; /* Fonte elegante para o cabe√ßalho */
        }
        .table {
            color: white; /* Texto branco nas tabelas */
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.1); /* Tons leves de branco para linhas √≠mpares */
        }
        .table-striped tbody tr:nth-of-type(even) {
            background-color: rgba(255, 255, 255, 0.05); /* Tons leves de branco para linhas pares */
        }
        .alert-stock {
            color: #ff6f61; /* Coral para alertas de estoque */
        }
        .footer {
            background-color: #111;
            color: white;
            padding: 20px 0;
            text-align: center;
        }
        .footer p {
            margin: 0;
            font-size: 1rem;
            color: #999;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/"><i class="fas fa-arrow-left"></i> Voltar √† P√°gina Inicial</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item"><a class="nav-link" href="/clientes/listar"><i class="fas fa-users"></i> Lista de Clientes</a></li>
            <li class="nav-item"><a class="nav-link" href="/produto/listar"><i class="fas fa-box-open"></i> Lista de Produtos</a></li>
            <li class="nav-item"><a class="nav-link" href="/transacao/listar"><i class="fas fa-receipt"></i> Lista de Transa√ß√µes</a></li>
        </ul>
    </div>
</nav>
<div class="container">
    <h1>Realizar Venda</h1>
    <form id="inserirTransacao" action="/transacao/salvarTransacao" method="post">
        <div class="row">
            <div class="col-md-12">
                <!-- Campo Cliente -->
                <div class="form-group">
                    <label for="cliente">Cliente:</label>
                    <div class="d-flex">
                        <input type="text" class="form-control w-25" id="clienteId" name="clienteId" readonly title="ID do Cliente">
                        <input type="text" class="form-control ml-2" id="pesquisaCliente" placeholder="Pesquisar Cliente por Nome ou ID">
                        <button type="button" class="btn btn-custom ml-2" id="buscarCliente">Buscar</button>
                    </div>
                    <select class="form-control mt-2" id="cliente" name="clienteId" required title="Selecione um cliente">
                        <option value="">Selecione o Cliente</option>
                    </select>
                    <small class="form-text text-muted"><a href="/clientes/criarClienteForm" style="color: #d4af37;"><i class="fas fa-user-plus"></i> Cadastrar Novo Cliente</a></small>
                </div>

                <!-- Campo Oculto para Telefone do Cliente -->
                <input type="hidden" id="clienteTelefone" name="clienteTelefone">

                <!-- Tabela de Produtos -->
                <table class="table table-striped table-responsive-md" id="produtosTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Valor Uni</th>
                            <th>Valor Total</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="produtosBody">
                        <tr class="produto" data-index="0">
                            <td style="width: 5%;">
                                <input type="text" class="form-control produtoId" id="produtoId0" name="produtos[0].produtoId" readonly title="ID do Produto">
                            </td>
                            <td style="width: 45%;">
                                <div class="d-flex">
                                    <input type="text" class="form-control produtoPesquisa" id="pesquisaProduto0" placeholder="Pesquisar Produto por Nome ou ID">
                                    <button type="button" class="btn btn-custom ml-2 buscarProduto" data-index="0">Buscar</button>
                                </div>
                                <select class="form-control mt-2 produtoSelect" id="produto0" name="produtos[0].produtoId" required title="Selecione um produto">
                                    <option value="">Selecione o Produto</option>
                                </select>
                            </td>
                            <td style="width: 10%;">
                                <input type="number" class="form-control quantidadeInput" id="quantidade0" name="produtos[0].quantidade" value="1" min="1" required title="Quantidade">
                                <div id="estoqueMsg0" class="alert-stock"></div>
                            </td>
                            <td style="width: 10%;"><input type="text" class="form-control valorUnitarioInput" id="valorUnitario0" readonly title="Valor Unit√°rio"></td>
                            <td style="width: 10%;"><input type="text" class="form-control valorTotalInput" id="valorTotal0" readonly title="Valor Total"></td>
                            <td style="width: 10%;">
                                <button type="button" class="btn btn-danger btn-sm excluirProduto">Excluir</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Bot√£o de Adicionar Produto -->
                <button type="button" id="adicionarProduto" class="btn btn-secondary mt-2">Adicionar outro produto</button>
                
                <!-- Subtotal e Total -->
                <div class="d-flex justify-content-between mt-2">
                    <p><strong>Subtotal:</strong> <span id="subtotal">R$0,00</span></p>
                    <p><strong>Valor Total:</strong> <span id="valorTotal">R$0,00</span></p>
                </div>
                
                <!-- Forma de Pagamento -->
                <div class="form-row formaPagamentoDestaque mb-3">
                    <div class="col-md-6">
                        <label class="col-form-label" for="formaPagamento">Forma de Pagamento:</label>
                        <select class="form-control" id="formaPagamento" name="formaPagamento" required title="Selecione a forma de pagamento">
                            <option value="">Selecione a Forma de Pagamento</option>
                            <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                            <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Pix">Pix</option>
                            <option value="Credi√°rio">Credi√°rio</option>
                        </select>
                    </div>
                </div>
                
                <!-- Parcelamento -->
                <div class="form-row parcelamentoFields" style="display: none;">
                    <div class="col-md-6">
                        <label class="col-form-label" for="numeroParcelas">N√∫mero de Parcelas:</label>
                        <select class="form-control" id="numeroParcelas" name="numeroParcelas">
                            <option value="">Selecione o n√∫mero de parcelas</option>
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="3">3x</option>
                            <option value="4">4x</option>
                            <option value="5">5x</option>
                            <option value="6">6x</option>
                            <option value="7">7x</option>
                            <option value="8">8x</option>
                            <option value="9">9x</option>
                            <option value="10">10x</option>
                            <option value="11">11x</option>
                            <option value="12">12x</option>
                        </select>
                    </div>
                </div>
                
                <!-- Data de Vencimento -->
                <div class="form-row formaPagamentoDestaque mb-3">
                    <div class="col-md-6">
                        <label class="col-form-label" for="dataVencimento">Data de Vencimento:</label>
                        <input type="date" class="form-control" id="dataVencimento" name="dataVencimento" title="Data de Vencimento">
                    </div>
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <button type="submit" class="btn btn-custom">Concluir Venda</button>
                <button type="button" id="cancelarVenda" class="btn btn-danger">Cancelar Venda</button>
            </div>
            
            <!-- Resumo da Venda -->
            <div class="col-md-12 mt-3">
                <div class="resumo-vendas">
                    <h3 class="text-center">Resumo da Venda</h3>
                    <p><strong>Cliente (ID):</strong> <span id="resumoClienteId">-</span> - <span id="resumoCliente">N√£o definido</span></p>
                    <p><strong>Produtos:</strong> <span id="resumoProdutos"></span></p>
                    <p><strong>Subtotal:</strong> <span id="resumoSubtotal">R$0,00</span></p>
                    <p><strong>Forma de Pagamento:</strong> <span id="resumoFormaPagamento">N√£o definida</span></p>
                    <p><strong>Parcelamento:</strong> <span id="resumoParcelamento">N√£o definido</span></p>
                    <p><strong>Data de Compra:</strong> <span id="dataCompra"></span></p>
                    <div id="parcelasInfo"></div>
                    <p><strong>Total:</strong> <span id="resumoTotal">R$0,00</span></p>
                </div>
                <button type="button" class="btn btn-custom" id="imprimirResumo">Imprimir Resumo</button>
                <button type="button" class="btn btn-custom" id="enviarWhatsapp">Enviar para WhatsApp</button>
            </div>
        </div>
        
        <!-- Campos Ocultos -->
        <input type="hidden" id="inputResumoCliente" name="cliente">
        <input type="hidden" id="inputResumoSubtotal" name="subtotal">
        <input type="hidden" id="inputResumoFormaPagamento" name="formaPagamento">
        <input type="hidden" id="inputResumoParcelamento" name="parcelamento">
        <input type="hidden" id="inputResumoTotal" name="valorTotal">
        <input type="hidden" id="inputDataCompra" name="dataTransacao">
        <input type="hidden" id="inputResumoProdutos" name="produtos">
        <input type="hidden" name="dataTransacao" id="dataTransacao">
        <input type="hidden" name="status" id="status">
        <input type="hidden" name="valorTotal" id="valorTotal">
    </form>
</div>

<!-- Scripts necess√°rios -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<script>
$(document).ready(function() {
    function atualizarValorTotal(index) {
        const $produto = $(`#produto${index}`);
        const preco = parseFloat($produto.find(':selected').data('preco') || 0);
        const quantidade = parseInt($(`#quantidade${index}`).val() || 0);
        const valorTotal = preco * quantidade;
        const estoque = parseInt($produto.find(':selected').data('estoque') || 0);

        $(`#valorUnitario${index}`).val(`R$${preco.toFixed(2)}`);
        $(`#valorTotal${index}`).val(`R$${valorTotal.toFixed(2)}`);

        // Verifica se a quantidade √© maior que o estoque
        if (quantidade > estoque) {
            $(`#estoqueMsg${index}`).text(`Estoque insuficiente. Dispon√≠vel: ${estoque}`);
        } else {
            $(`#estoqueMsg${index}`).text('');
        }

        atualizarSubtotal();
    }

    function atualizarSubtotal() {
        let subtotal = 0;
        let produtos = '';

        $('.produto').each(function() {
            const index = $(this).data('index');
            const produtoId = $(`#produtoId${index}`).val();
            const produto = $(`#produto${index} option:selected`).text();
            const quantidade = $(`#quantidade${index}`).val();
            const valorUnitario = $(`#valorUnitario${index}`).val();
            const valorTotal = $(`#valorTotal${index}`).val();
            if (produto && quantidade && valorUnitario && valorTotal) {
                subtotal += parseFloat(valorTotal.replace('R$', ''));
                produtos += `<p>ID: ${produtoId} - ${produto} (${quantidade} x ${valorUnitario} = ${valorTotal})</p>`;
            }
        });

        $('#subtotal').text(`R$${subtotal.toFixed(2)}`);
        $('#resumoSubtotal').text(`R$${subtotal.toFixed(2)}`);
        $('#resumoTotal').text(`R$${subtotal.toFixed(2)}`);
        $('#valorTotal').text(`R$${subtotal.toFixed(2)}`);
        $('#resumoProdutos').html(produtos);
        atualizarParcelamento();
    }

    function atualizarParcelamento() {
        const formaPagamento = $('#formaPagamento').val();
        const numeroParcelas = $('#numeroParcelas').val();
        const subtotal = parseFloat($('#subtotal').text().replace('R$', ''));

        if ((formaPagamento === 'Cart√£o de Cr√©dito' || formaPagamento === 'Credi√°rio') && numeroParcelas > 0) {
            const parcelaValor = (subtotal / numeroParcelas).toFixed(2);
            let parcelasHtml = '';
            const dataVencimento = new Date($('#dataVencimento').val());

            for (let i = 1; i <= numeroParcelas; i++) {
                const vencimento = new Date(dataVencimento);
                vencimento.setMonth(vencimento.getMonth() + i - 1);
                const vencimentoStr = vencimento.toLocaleDateString('pt-BR');
                parcelasHtml += `<p>Parcela ${i} - R$${parcelaValor} - Vencimento: ${vencimentoStr}</p>`;
            }

            $('#resumoParcelamento').text(`${numeroParcelas}x de R$${parcelaValor}`);
            $('#parcelasInfo').html(parcelasHtml);
        } else {
            $('#resumoParcelamento').text('N√£o definido');
            $('#parcelasInfo').empty();
        }
    }

    function getDataAtual() {
        const hoje = new Date();
        const dataCompraStr = hoje.toLocaleDateString('pt-BR');
        const dataVencimento = new Date();
        dataVencimento.setDate(dataVencimento.getDate() + 30);
        const dataVencimentoStr = dataVencimento.toISOString().split('T')[0]; // Formato yyyy-mm-dd
        $('#dataVencimento').val(dataVencimentoStr);
        return dataCompraStr;
    }

    $('#dataCompra').text(getDataAtual());

    let index = 1;
    $('#adicionarProduto').on('click', function() {
        const $novoProduto = $('.produto:first').clone();
        $novoProduto.attr('data-index', index);
        $novoProduto.find('.produtoSelect').attr('id', `produto${index}`).attr('name', `produtos[${index}].produtoId`);
        $novoProduto.find('.quantidadeInput').attr('id', `quantidade${index}`).attr('name', `produtos[${index}].quantidade`).val(1);
        $novoProduto.find('.valorUnitarioInput').attr('id', `valorUnitario${index}`).val('');
        $novoProduto.find('.valorTotalInput').attr('id', `valorTotal${index}`).val('');
        $novoProduto.find('.produtoId').attr('id', `produtoId${index}`).val('');
        $novoProduto.find('.buscarProduto').attr('data-index', index); // Atualize o index do bot√£o buscar produto
        $novoProduto.find('.produtoPesquisa').attr('id', `pesquisaProduto${index}`).val(''); // Limpar o campo de pesquisa
        $novoProduto.find('.alert-stock').attr('id', `estoqueMsg${index}`).text(''); // Limpar mensagem de estoque

        $('#produtosBody').append($novoProduto);
        index++;
    });

    $('#produtosBody').on('click', '.excluirProduto', function() {
        const $produto = $(this).closest('.produto');
        if ($('#produtosBody .produto').length > 1) {
            Swal.fire({
                title: 'Tem certeza?',
                text: 'Voc√™ n√£o poder√° reverter isso!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'N√£o, cancelar!',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $produto.remove();
                    atualizarSubtotal();
                    Swal.fire(
                        'Exclu√≠do!',
                        'O produto foi exclu√≠do.',
                        'success'
                    );
                }
            });
        } else {
            Swal.fire({
                title: 'Tem certeza?',
                text: 'Voc√™ n√£o poder√° reverter isso!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'N√£o, cancelar!',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $produto.find('.produtoSelect').val('');
                    $produto.find('.quantidadeInput').val(1);
                    $produto.find('.valorUnitarioInput').val('');
                    $produto.find('.valorTotalInput').val('');
                    atualizarSubtotal();
                    Swal.fire(
                        'Limpo!',
                        'O formul√°rio foi limpo.',
                        'success'
                    );
                }
            });
        }
    });

    $('#produtosBody').on('change', '.produtoSelect, .quantidadeInput', function() {
        const index = $(this).closest('.produto').data('index');
        atualizarValorTotal(index);

        const produtoId = $(`#produto${index}`).val();
        $(`#produtoId${index}`).val(produtoId);
    });

    $('#formaPagamento').on('change', function() {
        const formaPagamento = $(this).val();
        $('#resumoFormaPagamento').text(formaPagamento);

        if (formaPagamento === 'Cart√£o de Cr√©dito' || formaPagamento === 'Credi√°rio') {
            $('.parcelamentoFields').show();
            $('#numeroParcelas').prop('required', true); // Torna o campo obrigat√≥rio quando vis√≠vel
        } else {
            $('.parcelamentoFields').hide();
            $('#numeroParcelas').prop('required', false); // Remove a obrigatoriedade quando escondido
            $('#numeroParcelas').val(''); // Limpa o valor do campo
            $('#resumoParcelamento').text('N√£o definido');
            $('#parcelasInfo').empty();
        }
        atualizarParcelamento();
    });

    $('#numeroParcelas').on('change', function() {
        atualizarParcelamento();
    });

    $('#dataVencimento').on('change', function() {
        atualizarParcelamento();
    });

    $('#cliente').on('change', function() {
        const clienteId = $(this).val();
        const clienteNome = $(this).find(':selected').text();
        const clienteTelefone = $(this).find(':selected').data('telefone');
        $('#clienteId').val(clienteId);
        $('#resumoClienteId').text(clienteId);
        $('#resumoCliente').text(clienteNome);
        $('#clienteTelefone').val(clienteTelefone || '');
    });

    $('#imprimirResumo').on('click', function() {
        window.print();
    });

    $('#cancelarVenda').on('click', function() {
        Swal.fire({
            title: 'Tem certeza?',
            text: 'Todos os dados ser√£o perdidos!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, cancelar!',
            cancelButtonText: 'N√£o, continuar!',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                $('#inserirTransacao')[0].reset();
                $('#resumoCliente').text('N√£o definido');
                $('#resumoProdutos').empty();
                $('#subtotal').text('R$0,00');
                $('#resumoSubtotal').text('R$0,00');
                $('#resumoTotal').text('R$0,00');
                $('#valorTotal').text('R$0,00');
                $('#resumoFormaPagamento').text('N√£o definida');
                $('#resumoParcelamento').text('N√£o definido');
                $('#parcelasInfo').empty();
                $('.parcelamentoFields').hide();
                $('#dataCompra').text(getDataAtual());
                Swal.fire(
                    'Cancelado!',
                    'A venda foi cancelada.',
                    'success'
                );
            }
        });
    });

    $('#inserirTransacao').on('submit', function(event) {
        event.preventDefault();

        // Remover qualquer campo oculto existente para a forma de pagamento
        $('input[name="formaPagamento"]').remove();

        // Preencher os campos ocultos com os valores do resumo da venda
        $('#inputResumoCliente').val($('#resumoCliente').text());
        $('#inputResumoSubtotal').val($('#resumoSubtotal').text().replace('R$', '').trim());
        $('#inputResumoFormaPagamento').val($('#resumoFormaPagamento').text());
        $('#inputResumoParcelamento').val($('#resumoParcelamento').text());
        $('#inputResumoTotal').val($('#resumoTotal').text().replace('R$', '').trim());
        $('#inputDataCompra').val($('#dataCompra').text());
        $('#inputResumoProdutos').val($('#resumoProdutos').html());

        // Definir o status com base na forma de pagamento
        let status = 'Pendente';
        const formaPagamento = $('#formaPagamento').val();
        if (formaPagamento === 'Cart√£o de D√©bito' || formaPagamento === 'Cart√£o de Cr√©dito' || formaPagamento === 'Dinheiro' || formaPagamento === 'Pix') {
            status = 'Pago';
        }
        $('#status').val(status);

        // Adicionar campos ocultos para cada produto e quantidade
        $('.produto').each(function(index) {
            const produtoId = $(this).find('.produtoSelect').val();
            const quantidade = $(this).find('.quantidadeInput').val();
            $('#inserirTransacao').append(`<input type="hidden" name="itens[${index}].produtoId" value="${produtoId}">`);
            $('#inserirTransacao').append(`<input type="hidden" name="itens[${index}].quantidade" value="${quantidade}">`);
        });

        // Adicionar campos ocultos para cada parcela
        const parcelas = [];
        if (formaPagamento === 'Cart√£o de Cr√©dito' || formaPagamento === 'Credi√°rio') {
            const numeroParcelas = $('#numeroParcelas').val();
            const valorParcela = parseFloat($('#resumoTotal').text().replace('R$', '')) / numeroParcelas;
            const dataVencimento = new Date($('#dataVencimento').val());
            for (let i = 1; i <= numeroParcelas; i++) {
                const vencimento = new Date(dataVencimento);
                vencimento.setMonth(vencimento.getMonth() + i - 1);
                const parcela = {
                    valorParcela: valorParcela.toFixed(2),
                    dataVencimento: vencimento.toISOString().split('T')[0],
                    status: 'PENDENTE'
                };
                parcelas.push(parcela);
            }
        }
        parcelas.forEach((parcela, index) => {
            $('#inserirTransacao').append(`<input type="hidden" name="parcelas[${index}].valorParcela" value="${parcela.valorParcela}">`);
            $('#inserirTransacao').append(`<input type="hidden" name="parcelas[${index}].dataVencimento" value="${parcela.dataVencimento}">`);
            $('#inserirTransacao').append(`<input type="hidden" name="parcelas[${index}].status" value="${parcela.status}">`);
        });

        // Adicionar valores default para campos n√£o preenchidos
        $('#dataTransacao').val(new Date().toISOString().split('T')[0]);
        $('#valorTotal').val($('#resumoTotal').text().replace('R$', '').trim());

        // L√≥gica para exibir modal de op√ß√µes de envio e salvar transa√ß√£o
        Swal.fire({
            title: 'Venda realizada com sucesso!',
            text: 'Deseja enviar o resumo da venda para o WhatsApp do cliente?',
            icon: 'success',
            showCancelButton: true,
            confirmButtonText: 'Sim, enviar via WhatsApp',
            cancelButtonText: 'N√£o, apenas registrar'
        }).then((result) => {
            if (result.isConfirmed) {
                enviarWhatsapp();
            }
            window.location.href = '/transacao/listar';
        });

        // Enviar os dados da transa√ß√£o para o backend para registro
        var formData = $(this).serialize();
        $.post($(this).attr('action'), formData, function(response) {
            console.log('Transa√ß√£o salva:', response);
        }).fail(function(error) {
            Swal.fire('Erro!', error.responseText || 'Ocorreu um erro ao realizar a venda.', 'error');
        });
    });

    $('#buscarCliente').on('click', function() {
        var termo = $('#pesquisaCliente').val();
        $.ajax({
            url: '/transacao/pesquisar-clientes/' + termo,
            method: 'GET',
            success: function(data) {
                var clienteSelect = $('#cliente');
                clienteSelect.empty();
                clienteSelect.append('<option value="">Selecione o Cliente</option>');
                if (data.length > 0) {
                    data.forEach(function(cliente) {
                        clienteSelect.append('<option value="' + cliente.id + '" data-telefone="' + cliente.telefone + '">' + cliente.nome + '</option>');
                    });
                    if (data.length === 1) {
                        clienteSelect.val(data[0].id).change();
                    }
                } else {
                    Swal.fire('Aviso', 'Cliente n√£o encontrado!', 'warning');
                }
            },
            error: function(error) {
                Swal.fire('Erro!', 'Ocorreu um erro ao buscar clientes.', 'error');
            }
        });
    });

    $('#produtosBody').on('click', '.buscarProduto', function() {
        var index = $(this).data('index');
        var termo = $(`#pesquisaProduto${index}`).val();
        $.ajax({
            url: '/transacao/pesquisar-produtos/' + termo,
            method: 'GET',
            success: function(data) {
                var produtoSelect = $(`#produto${index}`);
                produtoSelect.empty();
                produtoSelect.append('<option value="">Selecione o Produto</option>');
                if (data.length > 0) {
                    data.forEach(function(produto) {
                        produtoSelect.append('<option value="' + produto.id + '" data-preco="' + produto.preco + '" data-estoque="' + produto.estoque + '">' + produto.nomeProduto + '</option>');
                    });
                    if (data.length === 1) {
                        produtoSelect.val(data[0].id).change();
                    }
                } else {
                    Swal.fire('Aviso', 'Produto n√£o encontrado!', 'warning');
                }
            },
            error: function(error) {
                Swal.fire('Erro!', 'Ocorreu um erro ao buscar produtos.', 'error');
            }
        });
    });

    function enviarWhatsapp() {
        const clienteId = $('#resumoClienteId').text();
        const clienteNome = $('#resumoCliente').text();
        const produtos = $('#resumoProdutos').html().replace(/<p>/g, '').replace(/<\/p>/g, '\n');
        const subtotal = $('#resumoSubtotal').text();
        const formaPagamento = $('#resumoFormaPagamento').text();
        const parcelamento = $('#resumoParcelamento').text();
        const dataCompra = $('#dataCompra').text();
        const total = $('#resumoTotal').text();
        const clienteTelefone = $('#clienteTelefone').val();

        let mensagem = `üìã *Resumo da Venda* üìã\n\n`;
        mensagem += `üë§ *Cliente*: ${clienteNome} (ID: ${clienteId})\n`;
        mensagem += `üõí *Produtos*:\n${produtos}`;
        mensagem += `üí∞ *Subtotal*: ${subtotal}\n`;
        mensagem += `üí≥ *Forma de Pagamento*: ${formaPagamento}\n`;
        
        if (formaPagamento === 'Credi√°rio') {
            const parcelas = $('#parcelasInfo').text().replace(/<p>/g, '').replace(/<\/p>/g, '\n');
            mensagem += `üóìÔ∏è *Parcelamento*: ${parcelamento}\n${parcelas}`;
        }

        mensagem += `üìÖ *Data de Compra*: ${dataCompra}\n`;
        mensagem += `üí≤ *Total*: ${total}\n\n`;
        mensagem += `Obrigado pela prefer√™ncia! üòä`;

        if (clienteTelefone) {
            const url = `https://api.whatsapp.com/send?phone=55${clienteTelefone}&text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');
        } else {
            Swal.fire('Erro!', 'N√∫mero de telefone do cliente n√£o encontrado.', 'error');
        }
    }
});
</script>
</body>
</html>
